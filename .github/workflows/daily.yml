name: Daily GitHub Trending

on:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 0 点执行
  workflow_dispatch:  # 允许手动执行

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Run script
        run: |
          python github_daily.py

      - name: Generate blog post with DeepSeek
        id: generate_post
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python generate_post.py

      - name: Publish to Halo
        env:
          HALO_TOKEN: ${{ secrets.HALO_TOKEN }}
        run: |
          python publish_to_halo.py
      
      - name: Commit processed repos CSV to main branch
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          # 显示当前分支和文件状态（在 git checkout 之前）
          echo "Current branch before checkout: $(git branch --show-current)"
          echo "Current ref: ${{ github.ref_name }}"
          echo "CSV file exists before checkout: $([ -f processed_repos.csv ] && echo 'yes' || echo 'no')"
          if [ -f processed_repos.csv ]; then
            echo "CSV file size before checkout: $(wc -c < processed_repos.csv) bytes"
            echo "CSV file content before checkout:"
            cat processed_repos.csv
          fi
          # 拉取最新的代码（但不覆盖本地修改）
          git fetch origin ${{ github.ref_name }}:${{ github.ref_name }} || true
          # 不要在 checkout 后覆盖我们刚写入的 CSV 文件
          # 直接在当前工作区提交（checkout action 已经把我们放在了正确的分支上）
          if [ -f processed_repos.csv ]; then
            # 检查文件是否有内容
            if [ -s processed_repos.csv ]; then
              git add processed_repos.csv
              git status
              # 检查是否有待提交的更改
              if git diff --staged --quiet; then
                echo "CSV file has no changes (already committed)"
              else
                git commit -m "Update processed repos CSV [skip ci]"
                git push origin ${{ github.ref_name }}
                echo "CSV file pushed successfully"
              fi
            else
              echo "警告: processed_repos.csv 文件为空，跳过提交"
            fi
          else
            echo "错误: processed_repos.csv file not found"
          fi
          
      - name: Push to gh-pages
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          # 先拉取最新的主分支，确保 CSV 文件已保存
          git fetch origin ${{ github.ref_name }}:${{ github.ref_name }} || true
          git checkout --orphan gh-pages
          mv github_daily.json index.json
          git add index.json
          git commit -m "Update daily trending"
          git push --force origin gh-pages