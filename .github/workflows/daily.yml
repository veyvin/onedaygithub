name: Daily GitHub Trending

on:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 0 点执行
  workflow_dispatch:  # 允许手动执行

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Debug - Check files before running scripts
        run: |
          echo "=== 文件状态检查 ==="
          ls -la
          echo "=== CSV 文件初始状态 ==="
          if [ -f processed_repos.csv ]; then
            echo "CSV 文件存在"
            cat processed_repos.csv
          else
            echo "CSV 文件不存在，将创建新文件"
          fi

      - name: Run GitHub trending script
        id: get_trending
        run: |
          echo "=== 运行 GitHub Trending 脚本 ==="
          python github_daily.py
          echo "=== 脚本执行后 CSV 状态 ==="
          if [ -f processed_repos.csv ]; then
            echo "CSV 文件存在，大小: $(wc -c < processed_repos.csv) 字节"
            echo "CSV 内容:"
            cat processed_repos.csv
          else
            echo "错误: CSV 文件未创建"
            exit 1
          fi

      - name: Generate blog post with DeepSeek
        id: generate_post
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python generate_post.py

      - name: Publish to Halo
        env:
          HALO_TOKEN: ${{ secrets.HALO_TOKEN }}
        run: |
          python publish_to_halo.py

      - name: Commit all changes to main branch
        run: |
          echo "=== 提交所有更改到主分支 ==="
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          # 显示当前状态
          echo "当前分支: $(git branch --show-current)"
          echo "文件状态:"
          git status
          
          # 添加所有更改的文件
          git add -A
          
          # 检查是否有更改需要提交
          if git diff --staged --quiet; then
            echo "没有需要提交的更改"
          else
            echo "提交更改..."
            git commit -m "Auto-update: GitHub trending data and processed repos [skip ci]"
            git push origin ${{ github.ref_name }}
            echo "更改已推送到 ${{ github.ref_name }}"
          fi

      - name: Push to gh-pages
        run: |
          echo "=== 更新 gh-pages 分支 ==="
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          # 切换到 gh-pages 分支
          git checkout --orphan gh-pages
          
          # 复制需要的文件
          if [ -f github_daily.json ]; then
            cp github_daily.json index.json
            git add index.json
            git commit -m "Update daily trending data"
            git push --force origin gh-pages
            echo "gh-pages 分支已更新"
          else
            echo "错误: github_daily.json 文件不存在"
            exit 1
          fi